<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <!-- ã€ä¿®æ”¹ã€‘ç¶²é æ¨™é¡Œ -->
  <title>é †ç„¶è—¥å“ ç·šä¸Šè¨‚è³¼ (Demo)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --primary: #007bff; --primary-hover: #0056b3; --bg: #f9fafb; --card-bg: #ffffff; --radius: 0.5rem; --gap: 1rem; --transition: 0.3s; } /* æ›´æ”¹ä¸»é¡Œè‰²ç‚ºè—è‰²ç³» */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100vw; height: 100vh; background: var(--bg); font-family: 'Noto Sans TC', sans-serif; }
    body { display: flex; justify-content: center; align-items: center; padding: var(--gap); }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 800px; display: flex; flex-direction: column; padding: var(--gap); max-height: 100%; }
    /* ã€ä¿®æ”¹ã€‘è«‹è¨˜å¾—æ›¿æ›æ‚¨çš„logoåœ–ç‰‡ï¼Œä¸¦åœ¨æ­¤èª¿æ•´å¤§å° */
    .logo { display: block; margin: 0 auto var(--gap); max-width: 250px; }
    /* ã€ä¿®æ”¹ã€‘æ¨™é¡Œæ–‡å­— */
    h2 { text-align: center; color: var(--primary); font-size: 1.5rem; margin-bottom: var(--gap); font-weight: 700; }
    form { flex: 1; display: flex; flex-direction: column; gap: var(--gap); overflow-y: auto; }
    label { font-size: 1rem; font-weight: 500; }
    input, select { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: var(--radius); transition: border-color var(--transition), box-shadow var(--transition); }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,123,255,0.2); outline: none; }
    select { margin-top: 0.5rem; }
    #currentCategory { font-size: 1rem; color: #374151; margin-bottom: 0.5rem; min-height: 1.2em; }
    #itemsContainer { display: flex; flex-wrap: wrap; gap: var(--gap); }
    .loading { font-size: 1rem; color: #6b7280; padding: 1rem; }
    .item-option { background: #fff; border-radius: var(--radius); box-shadow: 0 1px 4px rgba(0,0,0,0.08); display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 0.5rem; padding: 0.75rem; flex: 1 1 calc(50% - var(--gap)); transition: box-shadow var(--transition); cursor: pointer; }
    .item-option:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    @media (max-width: 900px) { .item-option { flex: 1 1 calc(50% - var(--gap)); } }
    @media (max-width: 600px) { .item-option { flex-basis: 100%; } }
    .item-label { font-size: 1.1rem; }
    .item-unit { font-size: 0.9rem; color: #6b7280; margin-left: 0.5rem; }
    .item-price { font-size: 0.9rem; color: var(--primary); font-weight: 700; }
    .qty-control { display: flex; align-items: center; }
    .qty-control input { width: 50px; text-align: center; border: 1px solid #d1d5db; border-radius: var(--radius); margin: 0 0.25rem; padding: 0.25rem; }
    .qty-control button { background: #e5e7eb; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background-color var(--transition); }
    .qty-control button:hover { background: #d1d5db; }
    .submit-btn { background: var(--primary); color: #fff; border: none; padding: 0.8rem; font-size: 1.1rem; border-radius: var(--radius); cursor: pointer; transition: background-color var(--transition); }
    .submit-btn:hover { background: var(--primary-hover); }
    .submit-btn:disabled { background: #a5d8ff; cursor: not-allowed; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal.active { display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--radius); }
    .modal-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    .modal-body { max-height: 60vh; overflow-y: auto; }
    .confirm-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    .remove-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    .modal-footer { margin-top: 1rem; text-align: right; }
    .modal-footer button { padding: 0.6rem 1.2rem; border-radius: var(--radius); border: none; cursor: pointer; }
    .btn-cancel { background-color: #d1d5db; }
    .btn-confirm { background-color: var(--primary); color: white; }
  </style>
</head>
<body>
  <div class="card">
    <!-- ã€ä¿®æ”¹ã€‘è«‹å°‡ 'logoå’Œå‹¤.jpg' æ›æˆæ‚¨è‡ªå·±çš„ Logo åœ–ç‰‡æª”å -->
    <img src="logo.jpg" alt="Logo" class="logo"/>
    <h2>é †ç„¶è—¥å“ ç·šä¸Šè¨‚è³¼ (Demo)</h2>
    <form id="orderForm">
      <label>è¨‚è³¼äºº</label>
      <input id="name" required placeholder="è«‹è¼¸å…¥ä»»ä½•è¨‚è³¼äººåç¨±"/>
      <label>é›»è©± (é¸å¡«)</label>
      <input id="phone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±ï¼ˆå¯ä¸å¡«ï¼‰"/>
      <label>é¸æ“‡é¡åˆ¥</label>
      <select id="category" disabled>
        <option disabled selected value="">è«‹å…ˆè¼¸å…¥è¨‚è³¼äººåç¨±</option>
      </select>
      <div id="currentCategory">ç•¶å‰é¡åˆ¥ï¼šâ€”</div>
      <div id="itemsContainer"></div>
      <button id="btn" class="submit-btn" type="submit">é€å‡ºè¨‚å–®</button>
    </form>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">è«‹ç¢ºèªæ‚¨çš„è¨‚å–®</div>
      <div class="modal-body" id="confirmList"></div>
      <div class="modal-footer">
        <button class="btn-cancel">å–æ¶ˆ</button>
        <button class="btn-confirm">ç¢ºèªé€å‡º</button>
      </div>
    </div>
  </div>

  <script>
    // è«‹å°‡æ­¤è™•çš„ URL æ›æˆæ‚¨è‡ªå·±éƒ¨ç½²å¾Œçš„ Web App URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbw4ePuUCW093sBnSgnvp85kb-kFZDRhuaCz6CzZGwFta3e_qaCpAkPa2eiVwc8FN_JBXA/exec';
    const pending = {};
    let allCategories = [];

    function jsonp(params) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.random().toString(36).substr(2);
        window[cb] = data => {
          try { delete window[cb]; document.getElementById(cb).remove(); } catch (e) {}
          resolve(data);
        };
        const script = document.createElement('script');
        script.id = cb;
        script.src = API_URL + '?' + new URLSearchParams({...params, callback: cb});
        script.onerror = () => {
          try { delete window[cb]; script.remove(); } catch (e) {}
          reject(new Error('JSONP error'));
        };
        document.body.appendChild(script);
      });
    }

    async function initializeApp() {
        document.getElementById('name').placeholder = "è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...";
        try {
            const data = await jsonp({ action: 'getInitialData' });
            if (data.error) throw new Error(data.error);
            allCategories = data.categories || [];
            document.getElementById('name').placeholder = "è«‹è¼¸å…¥ä»»ä½•è¨‚è³¼äººåç¨±";
        } catch (e) {
            alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ï¼š' + e.message);
            document.getElementById('name').placeholder = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ•´";
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();

      const nameInput = document.getElementById('name');
      const categorySelect = document.getElementById('category');
      
      nameInput.addEventListener('blur', () => {
        const name = nameInput.value.trim();
        if (name) {
          categorySelect.disabled = false;
          categorySelect.innerHTML = '<option disabled selected value="">è«‹é¸æ“‡é¡åˆ¥</option>' +
            allCategories.map(c => `<option value="${c}">${c}</option>`).join('');
        } else {
          categorySelect.disabled = true;
          categorySelect.innerHTML = '<option disabled selected value="">è«‹å…ˆè¼¸å…¥è¨‚è³¼äººåç¨±</option>';
          document.getElementById('itemsContainer').innerHTML = '';
          document.getElementById('currentCategory').textContent = 'ç•¶å‰é¡åˆ¥ï¼šâ€”';
        }
      });

      categorySelect.addEventListener('change', () => {
        const cat = categorySelect.value;
        if (!cat) return;
        loadItems(cat);
      });

      document.getElementById('orderForm').addEventListener('submit', e => {
        e.preventDefault();
        const arr = Object.values(pending);
        if (!arr.length) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …ï¼');
        showConfirmModal(arr);
      });

      document.querySelector('.btn-cancel').addEventListener('click', () => {
        document.getElementById('confirmModal').classList.remove('active');
      });

      document.querySelector('.btn-confirm').addEventListener('click', async () => {
        const arr = Object.values(pending);
        const btn = document.querySelector('.btn-confirm');
        btn.disabled = true;
        btn.textContent = 'é€å‡ºä¸­â€¦';
        try {
          const res = await jsonp({
            action: 'submitOrder',
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            orders: JSON.stringify(arr)
          });
          if (res.error) throw new Error(res.error);
          
          alert(`è¨‚å–®å®Œæˆï¼ç¸½é‡‘é¡ï¼š${res.total} å…ƒ`);

          document.getElementById('orderForm').reset();
          document.getElementById('itemsContainer').innerHTML = '';
          document.getElementById('currentCategory').textContent = 'ç•¶å‰é¡åˆ¥ï¼šâ€”';
          categorySelect.innerHTML = '<option disabled selected value="">è«‹å…ˆè¼¸å…¥è¨‚è³¼äººåç¨±</option>';
          categorySelect.disabled = true;
          for (let k in pending) delete pending[k];
        } catch (err) {
          alert('é€å‡ºå¤±æ•—ï¼š' + err.message);
        } finally {
          btn.textContent = 'ç¢ºèªé€å‡º';
          btn.disabled = false;
          document.getElementById('confirmModal').classList.remove('active');
        }
      });
      
      document.getElementById('confirmList').addEventListener('click', (e) => {
        if (e.target && e.target.classList.contains('remove-btn')) {
          const itemName = e.target.dataset.itemName;
          if (!itemName) return;
          delete pending[itemName];
          const mainItemCheckbox = document.querySelector(`.item-option input[type="checkbox"][value="${itemName}"]`);
          if (mainItemCheckbox) {
            const parentDiv = mainItemCheckbox.closest('.item-option');
            parentDiv.querySelector('input[type="checkbox"]').checked = false;
            parentDiv.querySelector('input[type="number"]').value = 0;
          }
          showConfirmModal(Object.values(pending));
        }
      });
    });

    async function loadItems(cat) {
      const container = document.getElementById('itemsContainer');
      const current = document.getElementById('currentCategory');
      current.textContent = `ç•¶å‰é¡åˆ¥ï¼š${cat}`;
      container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­â€¦</div>';
      let items;
      try {
        items = await jsonp({ action: 'getItemsWithPrice', cat });
      } catch (e) {
        alert('è¼‰å…¥å“é …å¤±æ•—ï¼š' + e.message);
        container.innerHTML = '';
        return;
      }
      container.innerHTML = '';
      items.forEach(o => {
        const div = document.createElement('div');
        div.className = 'item-option';
        const exist = pending[o.item] || { qty: 0 };
        
        const priceDisplay = `<br><span class="item-price">NT$ ${o.price}</span>`;
        
        const unitText = o.unit ? ` / ${o.unit}` : '';
        div.innerHTML = `
          <input type="checkbox" ${exist.qty > 0 ? 'checked' : ''} value="${o.item}">
          <div class="item-label">${o.item}<span class="item-unit">${unitText}</span>${priceDisplay}</div>
          <div class="qty-control">
            <button type="button" class="qty-minus">âˆ’</button>
            <input type="number" min="0" value="${exist.qty}">
            <button type="button" class="qty-plus">ï¼‹</button>
          </div>
        `;

        const cb = div.querySelector('input[type="checkbox"]');
        const qtyIn = div.querySelector('input[type="number"]');
        const btnM = div.querySelector('.qty-minus');
        const btnP = div.querySelector('.qty-plus');

        function update(v) {
          v = Math.max(0, parseInt(v, 10) || 0);
          qtyIn.value = v;
          cb.checked = v > 0;
          if (v > 0) {
            pending[o.item] = { item: o.item, unit: o.unit, price: o.price, qty: v };
          } else {
            delete pending[o.item];
          }
        }

        btnP.addEventListener('click', () => update(qtyIn.value * 1 + 1));
        btnM.addEventListener('click', () => update(qtyIn.value * 1 - 1));
        qtyIn.addEventListener('input', () => update(qtyIn.value));
        cb.addEventListener('click', e => { e.stopPropagation(); update(cb.checked ? 1 : 0); });
        div.addEventListener('click', e => {
          if ([btnM, btnP, qtyIn, cb].includes(e.target)) return;
          update(cb.checked ? 0 : 1);
        });
        container.appendChild(div);
      });
    }

    function showConfirmModal(arr) {
      const list = document.getElementById('confirmList');
      list.innerHTML = '';
      
      if (arr.length > 0) {
        arr.forEach(o => {
          const priceInfo = ` (NT$ ${o.price})`;
          const unitText = o.unit ? ` / ${o.unit}` : '';
          const row = document.createElement('div');
          row.className = 'confirm-item';
          row.innerHTML = `<span>${o.item}<span class="item-unit">${unitText}</span>${priceInfo} x ${o.qty}</span><button class="remove-btn" data-item-name="${o.item}">ğŸ—‘ï¸</button>`;
          list.appendChild(row);
        });
      } else {
        list.innerHTML = '<div>æ‚¨çš„è¨‚å–®æ˜¯ç©ºçš„ã€‚</div>';
      }

      document.getElementById('confirmModal').classList.add('active');
      document.querySelector('.btn-confirm').disabled = arr.length === 0;
    }
  </script>
</body>
</html>