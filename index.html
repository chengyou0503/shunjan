<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>é †ç„¶è—¥å“ ç·šä¸Šè¨‚è³¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary-color: #005f73; --primary-hover: #0a9396; --background-color: #f0f4f8;
      --card-bg: #ffffff; --text-primary: #1d3557; --text-secondary: #495057;
      --border-color: #dee2e6; --shadow-color: rgba(29, 53, 87, 0.1);
      --success-color: #2a9d8f; --error-color: #e63946;
      --border-radius: 8px; --gap: 1.25rem; --transition-speed: 0.2s;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { background: var(--background-color); font-family: 'Noto Sans TC', sans-serif; }
    body { display: flex; justify-content: center; align-items: flex-start; padding: var(--gap); min-height: 100vh; }
    .card {
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color);
      width: 100%; max-width: 900px; display: flex; flex-direction: column;
      padding: calc(var(--gap) * 1.5); max-height: calc(100vh - 2 * var(--gap));
    }
    .logo { display: block; margin: 0 auto var(--gap); max-width: 220px; }
    h2 { text-align: center; color: var(--primary-color); font-size: 1.75rem; margin-bottom: var(--gap); font-weight: 700; }
    h3 { color: var(--text-primary); font-size: 1.2rem; margin-bottom: 0.75rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
    form { display: flex; flex-direction: column; gap: var(--gap); overflow-y: auto; padding-right: 10px; flex: 1; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    label { font-size: 1rem; font-weight: 500; color: var(--text-primary); }
    input, textarea {
      width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--border-color);
      border-radius: var(--border-radius); transition: all var(--transition-speed); font-family: 'Noto Sans TC', sans-serif;
    }
    input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.2); outline: none; }
    input:disabled { background-color: #e9ecef; cursor: not-allowed; color: var(--text-secondary); }
    textarea { resize: vertical; min-height: 80px; }
    #itemsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: var(--gap); }
    .info-message { font-size: 1rem; color: #6b7280; padding: 1rem; text-align: center; width: 100%; grid-column: 1 / -1; }
    .item-option {
      background: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 2px 6px var(--shadow-color);
      display: grid; grid-template-columns: auto 1fr auto; align-items: center;
      gap: 0.75rem; padding: 0.75rem; transition: transform var(--transition-speed), box-shadow var(--transition-speed); cursor: pointer;
    }
    .item-option:hover { transform: translateY(-3px); box-shadow: 0 4px 12px var(--shadow-color); }
    .item-label-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .item-label { font-size: 1.1rem; font-weight: 500; color: var(--text-primary); }
    .item-price { font-size: 1rem; color: var(--primary-color); font-weight: 700; }
    .qty-control { display: flex; align-items: center; }
    .qty-control input { width: 50px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; margin: 0 0.25rem; padding: 0.25rem; font-size: 1rem; }
    .qty-control button { background: #f1f3f5; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 50%; width: 32px; height: 32px; font-size: 1.5rem; line-height: 1; cursor: pointer; transition: background-color var(--transition-speed); }
    .qty-control button:hover { background: #e9ecef; }
    .submit-btn {
      background: var(--primary-color); color: #fff; border: none; padding: 0.8rem; font-size: 1.1rem;
      border-radius: var(--border-radius); cursor: pointer; transition: background-color var(--transition-speed);
      display: flex; justify-content: center; align-items: center; gap: 0.5rem; font-weight: 500;
    }
    .submit-btn:hover { background: var(--primary-hover); }
    .submit-btn .spinner { display: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .submit-btn.loading .spinner { display: block; }
    .submit-btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal.active { display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--border-radius); }
    .modal-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    .modal-body { max-height: 60vh; overflow-y: auto; }
    .confirm-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    .remove-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    .modal-footer { margin-top: 1rem; text-align: right; }
    .modal-footer button { padding: 0.6rem 1.2rem; border-radius: var(--border-radius); border: none; cursor: pointer; font-weight: 500; }
    .btn-cancel { background-color: #d1d5db; }
    .btn-confirm { background-color: var(--primary-color); color: white; }
  </style>
</head>
<body>
  
  <div id="loginModal" class="modal active">
    <div class="modal-content">
      <div class="modal-header">é †ç„¶è—¥å“ è¨‚è³¼ç³»çµ±ç™»å…¥</div>
      <form id="loginForm">
          <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div class="form-group">
                <label for="loginAccount">å¸³è™Ÿ</label>
                <input id="loginAccount" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿ"/>
              </div>
              <div class="form-group">
                <label for="loginPassword">å¯†ç¢¼</label>
                <input id="loginPassword" type="password" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼"/>
              </div>
              <button id="loginBtn" class="submit-btn" type="submit">
                  <span class="btn-text">ç™»å…¥</span>
                  <div class="spinner"></div>
              </button>
              <p id="loginError" style="color: var(--error-color); text-align: center; display: none; margin-top: 0.5rem;"></p>
          </div>
      </form>
    </div>
  </div>
  
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">é¦–æ¬¡ç™»å…¥ - è«‹è¨­å®šæ‚¨çš„é›»å­éƒµä»¶</div>
      <p style="margin-bottom: 1rem;">ç‚ºäº†æ¥æ”¶è¨‚å–®ç¢ºèªä¿¡ï¼Œè«‹è¨­å®šæ‚¨çš„ Email åœ°å€ã€‚</p>
      <form id="emailForm">
        <div class="form-group">
          <label for="userEmail">é›»å­éƒµä»¶</label>
          <input id="userEmail" type="email" required placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email"/>
        </div>
        <button id="emailSubmitBtn" class="submit-btn" type="submit" style="margin-top: 1rem;">
          <span class="btn-text">å„²å­˜ä¸¦é–‹å§‹è¨‚è³¼</span>
          <div class="spinner"></div>
        </button>
      </form>
    </div>
  </div>

  <div class="card" id="mainApp" style="visibility: hidden;">
    <img src="logo.jpg" alt="Logo" class="logo"/>
    <h2>é †ç„¶è—¥å“ ç·šä¸Šè¨‚è³¼</h2>
    <form id="orderForm">
      <section>
        <h3>è¨‚è³¼è³‡è¨Š</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="name">è¨‚è³¼äºº</label>
            <input id="name" required disabled/>
          </div>
          <div class="form-group">
            <label for="phone">é›»è©± (é¸å¡«)</label>
            <input id="phone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±"/>
          </div>
        </div>
        <div class="form-group" style="margin-top: var(--gap);">
          <label for="remarks">å‚™è¨» (é¸å¡«)</label>
          <textarea id="remarks" placeholder="æŒ‡å®šåˆ°è²¨æ™‚é–“æˆ–ç‰¹æ®Šäº‹é …è«‹å¡«å¯«æ–¼æ­¤"></textarea>
        </div>
      </section>

      <section>
        <h3>é¸æ“‡å“é …</h3>
        <div class="form-group">
          <label for="itemSearchInput">æœå°‹å“é …</label>
          <input id="itemSearchInput" disabled placeholder="è«‹å…ˆç™»å…¥"/>
        </div>
        <div id="itemsContainer" style="margin-top: var(--gap);"></div>
      </section>

      <button id="btn" class="submit-btn" type="submit">
        <span class="btn-text">é€å‡ºè¨‚å–®</span>
        <div class="spinner"></div>
      </button>
    </form>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">è«‹ç¢ºèªæ‚¨çš„è¨‚å–®</div>
      <div class="modal-body" id="confirmList"></div>
      <div class="modal-footer">
        <button class="btn-cancel">å–æ¶ˆ</button>
        <button class="btn-confirm">ç¢ºèªé€å‡º</button>
      </div>
    </div>
  </div>

  <div id="receiptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">è¨‚å–®å·²æˆåŠŸé€å‡ºï¼</div>
      <div class="modal-body" id="receiptContent"></div>
      <div class="modal-footer">
        <button id="closeReceiptBtn" class="btn-confirm">å®Œæˆ (æ–°å¢ä¸‹ä¸€ç­†)</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwE-iCkVShXLkQQwKoQ27XThnt1NHL_sIgK3rAg9j4Taccj373-Ehn-xCiCEtOA5z1a/exec';
    const pending = {};
    let allItems = [];
    let loggedInUser = null;

    function jsonp(params) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.random().toString(36).substr(2);
        window[cb] = data => {
          try { delete window[cb]; document.getElementById(cb).remove(); } catch (e) {}
          resolve(data);
        };
        const script = document.createElement('script');
        script.id = cb;
        script.src = API_URL + '?' + new URLSearchParams({...params, callback: cb});
        script.onerror = () => {
          try { delete window[cb]; script.remove(); } catch (e) {}
          reject(new Error('JSONP é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API ç¶²å€æˆ–ç¶²è·¯é€£ç·šã€‚'));
        };
        document.body.appendChild(script);
      });
    }

    async function initializeApp() {
        try {
            const data = await jsonp({ action: 'getInitialData' });
            if (data.error) throw new Error(data.error);
            allItems = data.allItems || [];
        } catch (e) {
            alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ï¼š' + e.message);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();

      const mainApp = document.getElementById('mainApp');
      const loginModal = document.getElementById('loginModal');
      const loginForm = document.getElementById('loginForm');
      const loginBtn = document.getElementById('loginBtn');
      const loginError = document.getElementById('loginError');
      const emailModal = document.getElementById('emailModal');
      const emailForm = document.getElementById('emailForm');
      const emailSubmitBtn = document.getElementById('emailSubmitBtn');
      const itemSearchInput = document.getElementById('itemSearchInput');

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginBtn.classList.add('loading');
        loginBtn.disabled = true;
        loginError.style.display = 'none';
        try {
            const account = document.getElementById('loginAccount').value.trim();
            const password = document.getElementById('loginPassword').value;
            const res = await jsonp({ action: 'doLogin', account, password });
            if (!res.success) throw new Error(res.error);
            loggedInUser = res;
            if (res.emailRequired) {
                loginModal.classList.remove('active');
                emailModal.classList.add('active');
            } else {
                startOrdering();
            }
        } catch (err) {
            loginError.textContent = err.message;
            loginError.style.display = 'block';
        } finally {
            loginBtn.classList.remove('loading');
            loginBtn.disabled = false;
        }
      });
      
      emailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        emailSubmitBtn.classList.add('loading');
        emailSubmitBtn.disabled = true;
        try {
            const email = document.getElementById('userEmail').value.trim();
            const res = await jsonp({ action: 'updateEmail', account: loggedInUser.account, email });
            if (res.error) throw new Error(res.error);
            startOrdering();
        } catch (err) {
            alert('Email å„²å­˜å¤±æ•—ï¼š' + err.message);
        } finally {
            emailSubmitBtn.classList.remove('loading');
            emailSubmitBtn.disabled = false;
        }
      });

      function startOrdering() {
        loginModal.classList.remove('active');
        emailModal.classList.remove('active');
        mainApp.style.visibility = 'visible';
        document.getElementById('name').value = loggedInUser.name;
        document.getElementById('phone').value = loggedInUser.phone || '';
        itemSearchInput.disabled = false;
        itemSearchInput.placeholder = "è«‹è¼¸å…¥é—œéµå­—æœå°‹å“é …";
        renderItems([]);
      }
      
      itemSearchInput.addEventListener('input', () => {
        const searchTerm = itemSearchInput.value.trim().toLowerCase();
        if (searchTerm.length < 1) { renderItems([]); return; }
        const filteredItems = allItems.filter(item => item.item.toLowerCase().includes(searchTerm));
        renderItems(filteredItems);
      });

      document.getElementById('orderForm').addEventListener('submit', e => {
        e.preventDefault();
        const arr = Object.values(pending);
        if (!arr.length) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …ï¼');
        showConfirmModal(arr);
      });

      document.querySelector('.btn-cancel').addEventListener('click', () => {
        document.getElementById('confirmModal').classList.remove('active');
      });

      document.querySelector('.btn-confirm').addEventListener('click', async () => {
        const arr = Object.values(pending);
        const btn = document.querySelector('.btn-confirm');
        btn.disabled = true;
        btn.textContent = 'é€å‡ºä¸­â€¦';
        try {
            const orderData = {
                name: loggedInUser.name,
                phone: document.getElementById('phone').value.trim(),
                remarks: document.getElementById('remarks').value.trim(),
                orders: JSON.stringify(arr)
            };
            const res = await jsonp({ action: 'submitOrder', ...orderData });
            if (res.error) throw new Error(res.error);
            showReceiptModal(orderData, arr, res.total);
        } catch (err) {
            alert('é€å‡ºå¤±æ•—ï¼š' + err.message);
        } finally {
            btn.textContent = 'ç¢ºèªé€å‡º';
            btn.disabled = false;
            document.getElementById('confirmModal').classList.remove('active');
        }
      });
      
      document.getElementById('confirmList').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-btn')) {
            const itemName = e.target.dataset.itemName;
            if (!itemName) return;
            delete pending[itemName];
            const mainItemCheckbox = document.querySelector(`.item-option input[type="checkbox"][value="${itemName}"]`);
            if (mainItemCheckbox) {
                const parentDiv = mainItemCheckbox.closest('.item-option');
                parentDiv.querySelector('input[type="checkbox"]').checked = false;
                parentDiv.querySelector('input[type="number"]').value = 0;
            }
            showConfirmModal(Object.values(pending));
        }
      });

      document.getElementById('closeReceiptBtn').addEventListener('click', () => {
        document.getElementById('receiptModal').classList.remove('active');
        document.getElementById('orderForm').reset();
        document.getElementById('name').value = loggedInUser.name;
        document.getElementById('phone').value = loggedInUser.phone || '';
        renderItems([]);
        itemSearchInput.value = '';
        for (let k in pending) delete pending[k];
      });
    });

    function renderItems(itemsToRender) {
        const container = document.getElementById('itemsContainer');
        container.innerHTML = ''; 
        if (itemSearchInput.disabled) {
            container.innerHTML = '<div class="info-message">è«‹å…ˆç™»å…¥</div>';
            return;
        }
        if (itemsToRender.length === 0) {
            container.innerHTML = itemSearchInput.value ? '<div class="info-message">æ‰¾ä¸åˆ°ç¬¦åˆçš„å“é …</div>' : '<div class="info-message">è«‹åœ¨ä¸Šæ–¹æœå°‹æ¡†è¼¸å…¥é—œéµå­—ä¾†å°‹æ‰¾å“é …</div>';
            return;
        }
        itemsToRender.forEach(o => {
            const div = document.createElement('div');
            div.className = 'item-option';
            const exist = pending[o.item] || { qty: 0 };
            const unitText = o.unit ? ` / ${o.unit}` : '';
            div.innerHTML = `
            <input type="checkbox" ${exist.qty > 0 ? 'checked' : ''} value="${o.item}" style="width: 1.25rem; height: 1.25rem;">
            <div class="item-label-group">
              <div class="item-label">${o.item}<span class="item-unit">${unitText}</span></div>
              <div class="item-price">NT$ ${o.price}</div>
            </div>
            <div class="qty-control">
                <button type="button" class="qty-minus">âˆ’</button>
                <input type="number" min="0" value="${exist.qty}">
                <button type="button" class="qty-plus">ï¼‹</button>
            </div>`;
            const cb = div.querySelector('input[type="checkbox"]');
            const qtyIn = div.querySelector('input[type="number"]');
            const btnM = div.querySelector('.qty-minus');
            const btnP = div.querySelector('.qty-plus');
            function update(v) {
                v = Math.max(0, parseInt(v, 10) || 0);
                qtyIn.value = v;
                cb.checked = v > 0;
                if (v > 0) { pending[o.item] = { item: o.item, unit: o.unit, price: o.price, qty: v }; } 
                else { delete pending[o.item]; }
            }
            btnP.addEventListener('click', () => update(qtyIn.value * 1 + 1));
            btnM.addEventListener('click', () => update(qtyIn.value * 1 - 1));
            qtyIn.addEventListener('input', () => update(qtyIn.value));
            cb.addEventListener('click', e => { e.stopPropagation(); update(cb.checked ? 1 : 0); });
            div.addEventListener('click', e => { if (![btnM, btnP, qtyIn, cb].includes(e.target)) update(cb.checked ? 0 : 1); });
            container.appendChild(div);
        });
    }

    function showConfirmModal(arr) {
      const list = document.getElementById('confirmList');
      list.innerHTML = arr.length > 0 ? arr.map(o => `<div class="confirm-item"><span>${o.item}<span class="item-unit"> / ${o.unit || 'å€‹'}</span> (NT$ ${o.price}) x ${o.qty}</span><button class="remove-btn" data-item-name="${o.item}">ğŸ—‘ï¸</button></div>`).join('') : '<div>æ‚¨çš„è¨‚å–®æ˜¯ç©ºçš„ã€‚</div>';
      document.getElementById('confirmModal').classList.add('active');
      document.querySelector('.btn-confirm').disabled = arr.length === 0;
    }

    function showReceiptModal(orderData, orderedItems, total) {
        const receiptContent = document.getElementById('receiptContent');
        const now = new Date();
        const formattedDate = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        let itemsHtml = orderedItems.map(o => `<tr><td>${o.item} ${o.unit ? `(${o.unit})` : ''}</td><td style="text-align: right;">${o.qty}</td><td style="text-align: right;">${o.price}</td><td style="text-align: right;">${o.price * o.qty}</td></tr>`).join('');
        receiptContent.innerHTML = `
            <p><strong>è¨‚è³¼æ™‚é–“ï¼š</strong>${formattedDate}</p>
            <p><strong>è¨‚è³¼äººï¼š</strong>${orderData.name}</p>
            <p><strong>è¯çµ¡é›»è©±ï¼š</strong>${orderData.phone || 'æœªæä¾›'}</p>
            <p><strong>å‚™è¨»ï¼š</strong>${orderData.remarks || 'ç„¡'}</p>
            <hr style="margin: 1rem 0;">
            <table style="width:100%; border-collapse: collapse; text-align: left;">
                <thead><tr><th style="padding:8px;">å“é …</th><th style="padding:8px; text-align: right;">æ•¸é‡</th><th style="padding:8px; text-align: right;">å–®åƒ¹</th><th style="padding:8px; text-align: right;">å°è¨ˆ</th></tr></thead>
                <tbody>${itemsHtml}</tbody>
                <tfoot><tr><td colspan="3" style="text-align: right; padding-top: 10px;"><strong>ç¸½è¨ˆ</strong></td><td style="text-align: right; padding-top: 10px;"><strong>NT$ ${total}</strong></td></tr></tfoot>
            </table>`;
        document.getElementById('receiptModal').classList.add('active');
    }
  </script>
</body>
</html>