<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>三能國際 線上訂購</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --primary: #007bff; --primary-hover: #0056b3; --bg: #f9fafb; --card-bg: #ffffff; --radius: 0.5rem; --gap: 1rem; --transition: 0.3s; }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100vw; min-height: 100vh; background: var(--bg); font-family: 'Noto Sans TC', sans-serif; }
    body { display: flex; justify-content: center; align-items: center; padding: var(--gap); }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 800px; display: flex; flex-direction: column; padding: var(--gap); }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; font-size: 1.2rem; text-align: center; }
    .hidden { display: none !important; }
    .logo { display: block; margin: 0 auto var(--gap); max-width: 250px; }
    h2 { text-align: center; color: var(--primary); font-size: 1.5rem; margin-bottom: var(--gap); font-weight: 700; }
    .welcome-msg { text-align: center; margin-bottom: 1rem; font-size: 1.1rem; }
    .announcement-box { background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: var(--radius); padding: 0.75rem 1rem; margin-bottom: var(--gap); font-size: 0.95rem; color: #8a6d3b; }
    .announcement-box p { margin: 0.25rem 0; }
    form { display: flex; flex-direction: column; gap: var(--gap); }
    label { font-size: 1rem; font-weight: 500; }
    input, select, textarea { width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: var(--radius); transition: border-color var(--transition), box-shadow var(--transition); font-family: 'Noto Sans TC', sans-serif;}
    textarea { resize: vertical; min-height: 60px; }
    #currentCategory { font-size: 1rem; color: #374151; margin-bottom: 0.5rem; min-height: 1.2em; font-weight: bold; }
    #itemsContainer { display: flex; flex-wrap: wrap; gap: var(--gap); }
    .info-message, .loading { font-size: 1rem; color: #6b7280; padding: 1rem; text-align: center; width: 100%; }
    .item-option { background: #fff; border-radius: var(--radius); box-shadow: 0 1px 4px rgba(0,0,0,0.08); display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 0.5rem; padding: 0.75rem; flex: 1 1 calc(50% - var(--gap)); cursor: pointer; }
    .qty-control { display: flex; align-items: center; }
    .qty-control input { width: 50px; text-align: center; border: 1px solid #d1d5db; border-radius: var(--radius); margin: 0 0.25rem; padding: 0.25rem; }
    .qty-control button { background: #e5e7eb; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    .submit-btn { background: var(--primary); color: #fff; border: none; padding: 0.8rem; font-size: 1.1rem; border-radius: var(--radius); cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal.active { display: flex; justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--radius); }
    .modal-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
    .modal-body { max-height: 60vh; overflow-y: auto; }
    .confirm-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    .modal-footer { margin-top: 1rem; text-align: right; }
    .btn-cancel { background-color: #d1d5db; }
    .btn-confirm { background-color: var(--primary); color: white; }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay">
    <p>正在與 LINE 連線，請稍候...</p>
    <p id="loadingError" style="color: red; margin-top: 1rem; font-size: 0.9rem; max-width: 90%;"></p>
  </div>
  
  <div id="app" class="card hidden">
    <img src="logo.png" alt="Logo" class="logo"/>
    <h2>三能國際 線上訂購</h2>
    <div class="welcome-msg" id="welcomeMsg"></div>
    
    <div class="announcement-box">
      <p><strong>注意：</strong>每日訂單截止時間為15：00，15：00後為隔日訂單。</p>
      <p>指定到貨時間或有特殊事項要告知，請善用備註欄喔!</p>
    </div>

    <form id="orderForm">
      <label>訂購人/店家名稱</label>
      <input id="name" required />
      <label>電話 (選填)</label>
      <input id="phone" placeholder="請輸入聯絡電話"/>
      <label>選擇類別</label>
      <select id="category" disabled><option disabled selected value="">請先選擇類別</option></select>
      <label for="remarks">備註 (選填)</label>
      <textarea id="remarks" placeholder="指定到貨時間或特殊事項請填寫於此"></textarea>
      <div id="currentCategory"></div>
      <div id="itemsContainer"><div class="info-message">請先選擇商品類別</div></div>
      <button id="submitBtn" class="submit-btn" type="submit">送出訂單</button>
    </form>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">請確認您的訂單</div>
      <div class="modal-body" id="confirmList"></div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel">取消</button>
        <button type="button" class="btn-confirm">確認送出</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================================
    // ===                 【第 1 步】重要設定                 ===
    // ==========================================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbyT8k_vUibr9CD_ijFXWjPuzOub7opUWyrSjiYb7s5EQ2UVqISGat4BtKga0BCk7Sh8Gw/exec';        // <--- 務必替換！
    const LINE_LOGIN_CLIENT_ID = '2008189875'; // <--- 已填入你的 Channel ID

    let currentUser = null;
    const pending = {};

    async function callApi(action, method = 'GET', body = null) {
      const isPost = method.toUpperCase() === 'POST';
      const url = isPost ? API_URL : `${API_URL}?action=${action}&${new URLSearchParams(body || {})}`;
      const options = {
        method: method,
        mode: 'cors',
        headers: {},
        redirect: 'follow',
      };
      if (isPost) {
        options.headers['Content-Type'] = 'text/plain;charset=UTF-8';
        options.body = JSON.stringify({ action, ...body });
      }

      try {
        const response = await fetch(url, options);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        return data;
      } catch (error) {
        console.error(`API Call Failed for action "${action}":`, error);
        throw error;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const loadingErrorP = document.getElementById('loadingError');
      if (API_URL === 'YOUR_APPS_SCRIPT_EXEC_URL') {
        loadingErrorP.textContent = '錯誤：前端尚未設定後端 API_URL！';
        return;
      }
      
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');

      if (error) {
         loadingErrorP.textContent = `LINE 登入失敗：${params.get('error_description') || '您可能拒絕了授權'}`;
         return;
      }

      if (code) {
        try {
          document.getElementById('loadingOverlay').querySelector('p').textContent = '身份驗證成功，正在載入資料...';
          const res = await callApi('handleLineLogin', 'POST', { code });
          currentUser = res.profile;
          window.history.replaceState({}, document.title, window.location.pathname);
          main();
        } catch (err) {
          loadingErrorP.textContent = `LINE 驗證失敗: ${err.message}`;
        }
      } else {
        redirectToLineLogin();
      }
    });

    function redirectToLineLogin() {
      const state = Date.now().toString();
      const redirectUri = window.location.href.split('?')[0];
      const authUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${LINE_LOGIN_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=profile%20openid&state=${state}`;
      window.location.href = authUrl;
    }

    async function main() {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('welcomeMsg').innerHTML = `歡迎, <strong>${currentUser.displayName}</strong>！`;
      document.getElementById('name').value = currentUser.displayName;
      
      bindEventListeners();

      try {
        const data = await callApi('getInitialData', 'GET');
        const categorySelect = document.getElementById('category');
        categorySelect.disabled = false;
        categorySelect.innerHTML = '<option disabled selected value="">請選擇類別</option>' +
          (data.categories || []).map(c => `<option value="${c}">${c}</option>`).join('');
      } catch (err) {
        alert(`載入商品類別失敗: ${err.message}`);
      }
    }

    function bindEventListeners() {
        document.getElementById('category').addEventListener('change', (e) => loadItems(e.target.value));
        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (Object.keys(pending).length === 0) return alert('請至少選擇一個品項！');
            showConfirmModal();
        });
        document.querySelector('.btn-cancel').addEventListener('click', () => document.getElementById('confirmModal').classList.remove('active'));
        document.querySelector('.btn-confirm').addEventListener('click', submitOrder);
    }

    async function loadItems(cat) {
      if (!cat) return;
      const container = document.getElementById('itemsContainer');
      document.getElementById('currentCategory').textContent = `當前類別：${cat}`;
      container.innerHTML = '<div class="loading">品項載入中…</div>';
      try {
        const items = await callApi('getItemsByCategory', 'GET', { cat });
        container.innerHTML = '';
        if (items.length === 0) {
          container.innerHTML = '<div class="info-message">此類別下目前沒有品項</div>';
          return;
        }
        items.forEach(o => {
          const div = document.createElement('div');
          div.className = 'item-option';
          const exist = pending[o.item] || { qty: 0 };
          div.innerHTML = `...`; // 省略品項 HTML 結構，與舊版相同
          // ... 綁定品項增減事件 ...
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = `<div class="info-message">載入品項失敗: ${err.message}</div>`;
      }
    }

    async function submitOrder() {
        const btn = document.querySelector('.btn-confirm');
        btn.disabled = true;
        btn.textContent = '送出中…';
        const payload = {
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            remarks: document.getElementById('remarks').value.trim(),
            orders: Object.values(pending),
            user: currentUser
        };
        try {
            const res = await callApi('submitOrder', 'POST', payload);
            alert(`訂單已成功送出！總金額：${res.total} 元`);
            // ... 重置表單 ...
        } catch (err) {
            alert(`送出訂單失敗: ${err.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = '確認送出';
            document.getElementById('confirmModal').classList.remove('active');
        }
    }

    function showConfirmModal() {
        const list = document.getElementById('confirmList');
        list.innerHTML = '';
        // ... 根據 pending 物件產生確認列表的 HTML ...
        document.getElementById('confirmModal').classList.add('active');
    }
  </script>
</body>
</html>